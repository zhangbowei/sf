{"version":3,"sources":["../src/post.js"],"names":["arguments","article","tags","title","getMainPage","then","login","getWritePage","getDraftId","getTags","postBlog","console","log","origin","data","url","catch","err","body","base_headers","Accept","Connection","DNT","Host","Origin","Pragma","Referer","urls","write","draft","tag","blog","cookie","getToken","s","$","load","text","eq","fn","Function","token","getBlogId","v","val","Promise","fulfill","reject","get","end","res","headers","join","match","post","query","set","type","send","redirects","message","referer","blogId","do","weibo","id","articleId","draftId","pts","forEach","push","filter","_tag","name","all","ids","tagIds","license","created","content","Object","keys","map","k","concat","tagId"],"mappings":"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","file":"../src/post.js","sourcesContent":["import request from 'superagent'\nimport cheerio from 'cheerio'\nimport fs from 'fs'\nimport conf from './conf'\n\nlet article = ''\n, tags = []\n, title = ''\n\nexport default function () {\n\n  [article, tags, title] = arguments\n\n  getMainPage()\n  .then(login)\n  .then(getWritePage)\n  .then(getDraftId)\n  .then(getTags)\n  .then(postBlog)\n  .then(data => {\n    console.log('创建Blog成功!')\n    console.log('Blog的Url为:', `${origin}${data.url}`)\n    console.log(data)\n  })\n  .catch(err => console.log(err.body))\n}\n\nconst base_headers = {\n    Accept: '*/*',\n    'Accept-Encoding':'gzip, deflate',\n    'Accept-Language':'zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4,ja;q=0.2',\n    'Cache-Control':'no-cache',\n    Connection:'keep-alive',\n    DNT:1,\n    Host:'segmentfault.com',\n    Origin: 'https://segmentfault.com',\n    Pragma:'no-cache',\n    Referer: 'https://segmentfault.com/',\n    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36',\n    'X-Requested-With': 'XMLHttpRequest'}\n, origin = 'https://segmentfault.com'\n, urls = {\n  origin,\n  login: `${origin}/api/user/login`,\n  write: `${origin}/write?freshman=1`,\n  draft: `${origin}/api/article/draft/save`,\n  tag: `${origin}/api/tags/search`,\n  blog: `${origin}/api/articles/add` } \n\nlet cookie\n\nfunction getToken(s) {\n  let $ = cheerio.load(s)\n  , text = $('body>script').eq(1).text()\n  , fn = new Function('window', text + ';return window.SF.token')\n  , token = fn({})\n\n  $ = null\n  return token\n}\n\nfunction getBlogId(s) {\n  let $ = cheerio.load(s)\n  ,  v = $('select[name=blogId]').val()\n  $ = null\n\n  return(v)\n}\n\nfunction getMainPage() {\n  return new Promise((fulfill, reject) => {\n    request\n    .get(urls.origin)\n    .end((err, res) => {\n      if(err) reject(err)\n      else fulfill(res)\n    })\n  })\n}\n\nfunction login(res) {\n  let token = getToken(res.text)\n\n  cookie = res.headers['set-cookie'].join(',').match(/(PHPSESSID=.+?);/)[1]\n  return new Promise((fulfill, reject) => {\n    request\n      .post(urls.login)\n      .query({'_': token})\n      .set(base_headers)\n      .set('Cookie', cookie)\n      .type('form')\n      .send(conf)\n      .redirects(0)\n      .end((err, res) => {\n        if(err) reject(err)\n        else if(res.body.message !== '') reject(res)\n        else fulfill()\n      })\n  })\n}\n\nfunction getWritePage() {\n  let referer = urls.write\n  return new Promise((fulfill, reject) => {\n    request\n      .get(urls.write)\n      .set(base_headers)\n      .set('Cookie', cookie)\n      .set('Referer', referer)\n      .end((err, res) => {\n        if(err) reject(err)\n        else fulfill(res)\n      })\n  })\n}\n\nfunction getDraftId(res) {\n  let referer = urls.write\n  , token = getToken(res.text)\n  , blogId = getBlogId(res.text)\n\n    return new Promise((fulfill, reject) => {\n      request\n        .post(urls.draft)\n        .query({'_': token})\n        .set(base_headers)\n        .set('Cookie', cookie)\n        .set('Referer', referer)\n        .type('form')\n        .send({\n          do: 'saveArticle',\n          type: 'article',\n          title: '',\n          text: '',\n          weibo: 0,\n          blogId,\n          id: '',\n          articleId: '',\n          'tags%5B%5D': ''\n        })\n        .redirects(0)\n        .end((err, res) => {\n          if(err) reject(err)\n          else fulfill([res.body.data, token, blogId])\n        })\n    })\n  }\n\nfunction getTags() {\n  let [draftId, token, blogId] = arguments[0]\n  let referer = urls.write\n\n  let pts = []\n\n  tags.forEach( tag => pts.push( new Promise((fulfill, reject) => {\n    request\n      .get(urls.tag)\n      .query({'q': tag})\n      .query({'_': token})\n      .set(base_headers)\n      .set('Cookie', cookie)\n      .set('Referer', referer)\n      .redirects(0)\n      .end((err, res) => {\n        if(err) reject(err)\n        else fulfill(res)\n      })\n    }).then(res => {\n      let v = res.body.data.filter(_tag => _tag.name === tag)[0]\n      if (v) return v.id\n    }))\n  )\n  return Promise.all(pts).then( ids => [draftId, token, blogId, ids.filter(v=>v)])\n}\n\nfunction postBlog() {\n  let [draftId, token, blogId, tagIds] = arguments[0]\n  , referer = urls.write\n  , blog = {\n    title,\n    text: article,\n    id: '',\n    blogId,\n    weibo: 0,\n    license: 1,\n    draftId,\n    created: ''\n  }\n  , content = Object.keys(blog)\n                .map(k => `${k}=${blog[k]}`)\n                .concat(tagIds.map(tagId => `tags%5B%5D=${tagId}`))\n                .join('&')\n\n  return new Promise((fulfill, reject) => {\n    request\n      .post(urls.blog)\n      .query('_=' + token)\n      .set(base_headers)\n      .set('Cookie', cookie)\n      .set('Referer', referer)\n      .type('form')\n      .send(content)\n      .redirects(0)\n      .end((err, res) => {\n        if(err) reject(err)\n        else fulfill(res.body.data)\n      })\n    })\n}\n"]}